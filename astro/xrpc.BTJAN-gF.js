const mt=new TextEncoder;new TextDecoder;const gt=crypto.subtle,_t=t=>new Uint8Array(t),vt=_t,W=t=>mt.encode(t),Et=async t=>new Uint8Array(await gt.digest("SHA-256",t)),kt=/^did:([a-z]+):([a-zA-Z0-9._:%-]*[a-zA-Z0-9._-])$/,De=t=>typeof t=="string"&&t.length>=7&&t.length<=2048&&kt.test(t),xt=/^([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$/,Rt=t=>typeof t=="string"&&t.length>=3&&t.length<=253&&xt.test(t);function D(t){return{ok:!1,code:"invalid_type",expected:t}}const Ue=D([]),Ie=D(["string"]),Tt=D(["number"]),At=D(["bigint"]),bt=D(["boolean"]),je=D(["undefined"]),Le=D(["null"]),St=D(["object"]),Dt=D(["array"]),we={ok:!1,code:"missing_value"};function z(t,e){return t?{ok:!1,code:"join",left:t,right:e}:e}function N(t,e){return{ok:!1,code:"prepend",key:t,tree:e}}function Ut(t,e){var n;const s=t.code;switch(s){case"invalid_type":return{code:s,path:e,expected:t.expected};case"invalid_literal":return{code:s,path:e,expected:t.expected};case"missing_value":return{code:s,path:e};case"invalid_length":return{code:s,path:e,minLength:t.minLength,maxLength:t.maxLength};case"unrecognized_keys":return{code:s,path:e,keys:t.keys};case"invalid_union":return{code:s,path:e,tree:t.tree,issues:Q(t.tree)};case"custom_error":return typeof t.error=="object"&&t.error.path!==void 0&&e.push(...t.error.path),{code:s,path:e,message:typeof t.error=="string"?t.error:(n=t.error)===null||n===void 0?void 0:n.message,error:t.error}}}function Q(t,e=[],n=[]){for(;;)if(t.code==="join")Q(t.left,e.slice(),n),t=t.right;else if(t.code==="prepend")e.push(t.key),t=t.tree;else return n.push(Ut(t,e)),n}function ue(t,e){return t.length===0?"nothing":t.length===1?t[0]:`${t.slice(0,-1).join(", ")} ${e} ${t[t.length-1]}`}function xe(t){return typeof t=="bigint"?`${t}n`:JSON.stringify(t)}function ze(t){let e=0;for(;;)if(t.code==="join")e+=ze(t.left),t=t.right;else if(t.code==="prepend")t=t.tree;else return e+1}function Pe(t){let e="",n=0;for(;;)if(t.code==="join")n+=ze(t.right),t=t.left;else if(t.code==="prepend")e+=`.${t.key}`,t=t.tree;else break;let s="validation failed";if(t.code==="invalid_type")s=`expected ${ue(t.expected,"or")}`;else if(t.code==="invalid_literal")s=`expected ${ue(t.expected.map(xe),"or")}`;else if(t.code==="missing_value")s="missing value";else if(t.code==="unrecognized_keys"){const o=t.keys;s=`unrecognized ${o.length===1?"key":"keys"} ${ue(o.map(xe),"and")}`}else if(t.code==="invalid_length"){const o=t.minLength,a=t.maxLength;s="expected an array with ",o>0?a===o?s+=`${o}`:a!==void 0?s+=`between ${o} and ${a}`:s+=`at least ${o}`:s+=`at most ${a??"âˆž"}`,s+=" item(s)"}else if(t.code==="custom_error"){const o=t.error;typeof o=="string"?s=o:o!==void 0&&(o.message!==void 0&&(s=o.message),o.path!==void 0&&(e+="."+o.path.join(".")))}let r=`${t.code} at .${e.slice(1)} (${s})`;return n===1?r+=" (+ 1 other issue)":n>1&&(r+=` (+ ${n} other issues)`),r}function b(t,e,n,s){return Object.defineProperty(t,e,{value:n,enumerable:s,writable:!1}),n}class Ne extends Error{constructor(e){super(Pe(e)),Object.setPrototypeOf(this,new.target.prototype),this.name=new.target.name,this._issueTree=e}get issues(){return b(this,"issues",Q(this._issueTree),!0)}}class Oe{constructor(e){this.ok=!1,this._issueTree=e}get issues(){return b(this,"issues",Q(this._issueTree),!0)}get message(){return b(this,"message",Pe(this._issueTree),!0)}throw(){throw new Ne(this._issueTree)}}function O(t){return{ok:!0,value:t}}function G(t){return new Oe({ok:!1,code:"custom_error",error:t})}function $e(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}const L=1,H=2,ee=4,Me=0,It=1,Ce=2,jt=3,Lt=4,zt=5,Fe=6,Ge=7,Pt=8,Ke=9,Be=10,He=11,qe=12,Je=13,Xe=14,I=(t,e)=>({tag:t,match:e});function k(t,e,n){switch(t.tag){case Me:return;case It:return Ue;case Ce:return typeof e=="string"?void 0:Ie;case jt:return typeof e=="number"?void 0:Tt;case Lt:return typeof e=="bigint"?void 0:At;case zt:return typeof e=="boolean"?void 0:bt;case Fe:return e===null?void 0:Le;case Ge:return e===void 0?void 0:je;case Pt:return t.match(e,n);case Ke:return t.match(e,n);case Be:return t.match(e,n);case He:return t.match(e,n);case qe:return t.match(e,n);case Je:return t.match(e,n);case Xe:return t.match(e,n);default:return t.match(e,n)}}const _=Symbol.for("@valita/internal");class We{default(e){const n=O(e);return new T(this.optional(),s=>s===void 0?n:void 0)}assert(e,n){const s={ok:!1,code:"custom_error",error:n};return new T(this,(r,o)=>e(r,de(o))?void 0:s)}map(e){return new T(this,(n,s)=>({ok:!0,value:e(n,de(s))}))}chain(e){return typeof e=="function"?new T(this,(n,s)=>{const r=e(n,de(s));return r.ok?r:r._issueTree}):new T(this,(n,s)=>k(e[_],n,s))}}class $ extends We{optional(e){const n=new Ot(this);return e?new T(n,s=>s===void 0?{ok:!0,value:e()}:void 0):n}nullable(e){const n=new Nt([qt(),this]);return e?new T(n,s=>s===null?{ok:!0,value:e()}:void 0):n}_toTerminals(e){e(this)}try(e,n){const s=k(this[_],e,n===void 0?L:n.mode==="strip"?H:n.mode==="passthrough"?0:L);return s===void 0||s.ok?{ok:!0,value:s===void 0?e:s.value}:new Oe(s)}parse(e,n){const s=k(this[_],e,n===void 0?L:n.mode==="strip"?H:n.mode==="passthrough"?0:L);if(s===void 0||s.ok)return s===void 0?e:s.value;throw new Ne(s)}}class Nt extends ${constructor(e){super(),this.name="union",this.options=e}get[_](){const e=this.options.map(n=>n[_]);return b(this,_,I(Je,(n,s)=>{let r=Ue;for(const o of e){const a=k(o,n,s);if(a===void 0||a.ok)return a;r=a}return r}),!1)}_toTerminals(e){for(const n of this.options)n._toTerminals(e)}}class Ot extends We{constructor(e){super(),this.name="optional",this.type=e}optional(e){return e?new T(this,n=>n===void 0?{ok:!0,value:e()}:void 0):this}get[_](){const e=this.type[_];return b(this,_,I(Ke,(n,s)=>n===void 0||s&ee?void 0:k(e,n,s)),!1)}_toTerminals(e){e(this),e(Jt()),this.type._toTerminals(e)}}function Ze(t,e){if(typeof t!="number"){const n=e>>5;for(let s=t.length;s<=n;s++)t.push(0);return t[n]|=1<<e%32,t}else return e<32?t|1<<e:Ze([t,0],e)}function M(t,e){return typeof t=="number"?e<32?t>>>e&1:0:t[e>>5]>>>e%32&1}class A extends ${constructor(e,n,s){super(),this.name="object",this.shape=e,this._restType=n,this._checks=s}get[_](){const e=$t(this.shape,this._restType,this._checks);return b(this,_,I(Be,(n,s)=>$e(n)?e(n,s):St),!1)}check(e,n){var s;const r={ok:!1,code:"custom_error",error:n};return new A(this.shape,this._restType,[...(s=this._checks)!==null&&s!==void 0?s:[],{func:e,issue:r}])}rest(e){return new A(this.shape,e)}extend(e){return new A(Object.assign(Object.assign({},this.shape),e),this._restType)}pick(...e){const n={};for(const s of e)x(n,s,this.shape[s]);return new A(n,void 0)}omit(...e){const n=Object.assign({},this.shape);for(const s of e)delete n[s];return new A(n,this._restType)}partial(){var e;const n={};for(const r of Object.keys(this.shape))x(n,r,this.shape[r].optional());const s=(e=this._restType)===null||e===void 0?void 0:e.optional();return new A(n,s)}}function x(t,e,n){e==="__proto__"?Object.defineProperty(t,e,{value:n,writable:!0,enumerable:!0,configurable:!0}):t[e]=n}function $t(t,e,n){const s=Object.keys(t).map((i,u)=>{const c=t[i];let f=!1;return c._toTerminals(l=>{f||(f=l.name==="optional")}),{key:i,index:u,matcher:c[_],optional:f,missing:N(i,we)}}),r=Object.create(null);for(const i of s)r[i.key]=i;const o=e?.[_],a=s.length===0&&e?.name==="unknown"&&n===void 0;return(i,u)=>{if(a)return;let c,f,l,d=0,w=0;if(u&(L|H)||o!==void 0)for(const h in i){const p=i[h],m=r[h];if(m===void 0&&o===void 0){if(u&L)l===void 0?(l=[h],f=z(f,{ok:!1,code:"unrecognized_keys",keys:l})):l.push(h);else if(u&H&&f===void 0&&c===void 0){c={};for(let y=0;y<s.length;y++)if(M(d,y)){const g=s[y].key;x(c,g,i[g])}}continue}const v=k(m===void 0?o:m.matcher,p,u);if(v===void 0)c!==void 0&&f===void 0&&x(c,h,p);else if(!v.ok)f=z(f,N(h,v));else if(f===void 0){if(c===void 0)if(c={},o===void 0){for(let y=0;y<s.length;y++)if(M(d,y)){const g=s[y].key;x(c,g,i[g])}}else for(const y in i)x(c,y,i[y]);x(c,h,v.value)}m!==void 0&&(w++,d=Ze(d,m.index))}if(w<s.length)for(let h=0;h<s.length;h++){if(M(d,h))continue;const p=s[h],m=i[p.key];let v=0;if(m===void 0&&!(p.key in i)){if(!p.optional){f=z(f,p.missing);continue}v=ee}const y=k(p.matcher,m,u|v);if(y===void 0)c!==void 0&&f===void 0&&!v&&x(c,p.key,m);else if(!y.ok)f=z(f,N(p.key,y));else if(f===void 0){if(c===void 0)if(c={},o===void 0){for(let g=0;g<s.length;g++)if(g<h||M(d,g)){const E=s[g].key;x(c,E,i[E])}}else{for(const g in i)x(c,g,i[g]);for(let g=0;g<h;g++)if(!M(d,g)){const E=s[g].key;x(c,E,i[E])}}x(c,p.key,y.value)}}if(f!==void 0)return f;if(n!==void 0){for(const{func:h,issue:p}of n)if(!h(c??i))return p}return c&&{ok:!0,value:c}}}class K extends ${constructor(e,n,s){super(),this.name="array",this._prefix=e,this._rest=n,this._suffix=s}get[_](){var e,n;const s=this._prefix.map(c=>c[_]),r=this._suffix.map(c=>c[_]),o=(n=(e=this._rest)===null||e===void 0?void 0:e[_])!==null&&n!==void 0?n:I(1,()=>we),a=s.length+r.length,i=this._rest?1/0:a,u={ok:!1,code:"invalid_length",minLength:a,maxLength:i===1/0?void 0:i};return b(this,_,I(He,(c,f)=>{if(!Array.isArray(c))return Dt;const l=c.length;if(l<a||l>i)return u;const d=s.length,w=c.length-r.length;let h,p=c;for(let m=0;m<c.length;m++){const v=m<d?s[m]:m>=w?r[m-w]:o,y=k(v,c[m],f);y!==void 0&&(y.ok?(p===c&&(p=c.slice()),p[m]=y.value):h=z(h,N(m,y)))}return h||(c===p?void 0:{ok:!0,value:p})}),!1)}concat(e){if(this._rest){if(e._rest)throw new TypeError("can not concatenate two variadic types");return new K(this._prefix,this._rest,[...this._suffix,...e._prefix,...e._suffix])}else return e._rest?new K([...this._prefix,...this._suffix,...e._prefix],e._rest,e._suffix):new K([...this._prefix,...this._suffix,...e._prefix,...e._suffix],e._rest,e._suffix)}}function Z(t){const e=typeof t;return e!=="object"?e:t===null?"null":Array.isArray(t)?"array":e}function C(t){return[...new Set(t)]}function Ve(t){var e,n,s;const r=new Map,o=new Map,a=new Map,i=[],u=[],c=[];for(const{root:l,terminal:d}of t)if(r.set(l,(e=r.get(l))!==null&&e!==void 0?e:r.size),d.name!=="never")if(d.name==="optional")u.push(l);else if(d.name==="unknown")i.push(l);else if(d.name==="literal"){const w=(n=o.get(d.value))!==null&&n!==void 0?n:[];w.push(l),o.set(d.value,w),c.push(Z(d.value))}else{const w=(s=a.get(d.name))!==null&&s!==void 0?s:[];w.push(l),a.set(d.name,w),c.push(d.name)}const f=(l,d)=>{var w,h;return((w=r.get(l))!==null&&w!==void 0?w:0)-((h=r.get(d))!==null&&h!==void 0?h:0)};for(const[l,d]of o){const w=a.get(Z(l));w?(w.push(...d),o.delete(l)):o.set(l,C(d.concat(i)).sort(f))}for(const[l,d]of a)a.set(l,C(d.concat(i)).sort(f));return{types:a,literals:o,unknowns:C(i).sort(f),optionals:C(u).sort(f),expectedTypes:C(c)}}function Mt(t,e){var n;const s=[];for(const{root:h,terminal:p}of t)p.shape[e]._toTerminals(m=>s.push({root:h,terminal:m}));const{types:r,literals:o,optionals:a,unknowns:i,expectedTypes:u}=Ve(s);if(i.length>0||a.length>1)return;for(const h of o.values())if(h.length>1)return;for(const h of r.values())if(h.length>1)return;const c=N(e,we),f=N(e,r.size===0?{ok:!1,code:"invalid_literal",expected:[...o.keys()]}:{ok:!1,code:"invalid_type",expected:u}),l=o.size>0?new Map:void 0;if(l)for(const[h,p]of o)l.set(h,p[0][_]);const d=r.size>0?{}:void 0;if(d)for(const[h,p]of r)d[h]=p[0][_];const w=(n=a[0])===null||n===void 0?void 0:n[_];return(h,p)=>{var m;const v=h[e];if(v===void 0&&!(e in h))return w===void 0?c:k(w,h,p);const y=(m=d?.[Z(v)])!==null&&m!==void 0?m:l?.get(v);return y?k(y,h,p):f}}function Ct(t){var e;const n=[],s=new Map;for(const{root:r,terminal:o}of t){if(o.name==="unknown")return;if(o.name==="object"){for(const a in o.shape)s.set(a,((e=s.get(a))!==null&&e!==void 0?e:0)+1);n.push({root:r,terminal:o})}}if(!(n.length<2)){for(const[r,o]of s)if(o===n.length){const a=Mt(n,r);if(a)return a}}}function Ft(t){const{expectedTypes:e,literals:n,types:s,unknowns:r,optionals:o}=Ve(t),a=s.size===0&&r.length===0?{ok:!1,code:"invalid_literal",expected:[...n.keys()]}:{ok:!1,code:"invalid_type",expected:e},i=n.size>0?new Map:void 0;if(i)for(const[l,d]of n)i.set(l,d.map(w=>w[_]));const u=s.size>0?{}:void 0;if(u)for(const[l,d]of s)u[l]=d.map(w=>w[_]);const c=o.map(l=>l[_]),f=r.map(l=>l[_]);return(l,d)=>{var w,h;const p=d&ee?c:(h=(w=u?.[Z(l)])!==null&&w!==void 0?w:i?.get(l))!==null&&h!==void 0?h:f;let m=0,v=a;for(let y=0;y<p.length;y++){const g=k(p[y],l,d);if(g===void 0||g.ok)return g;v=m>0?z(v,g):g,m++}return m>1?{ok:!1,code:"invalid_union",tree:v}:v}}class Gt extends ${constructor(e){super(),this.name="union",this.options=e}_toTerminals(e){for(const n of this.options)n._toTerminals(e)}get[_](){const e=[];for(const r of this.options)r._toTerminals(o=>{e.push({root:r,terminal:o})});const n=Ft(e),s=Ct(e);return b(this,_,I(qe,(r,o)=>s!==void 0&&$e(r)?s(r,o):n(r,o)),!1)}}const Kt=Object.freeze({mode:"strict"}),Bt=Object.freeze({mode:"strip"}),Ht=Object.freeze({mode:"passthrough"});function de(t){return t&L?Kt:t&H?Bt:Ht}class T extends ${constructor(e,n){super(),this.name="transform",this._transformed=e,this._transform=n}get[_](){const e=[];let n=this;for(;n instanceof T;)e.push(n._transform),n=n._transformed;e.reverse();const s=n[_],r=O(void 0);return b(this,_,I(Xe,(o,a)=>{let i=k(s,o,a);if(i!==void 0&&!i.ok)return i;let u;i!==void 0?u=i.value:a&ee?(u=void 0,i=r):u=o;for(let c=0;c<e.length;c++){const f=e[c](u,a);if(f!==void 0){if(!f.ok)return f;u=f.value,i=f}}return i}),!1)}_toTerminals(e){this._transformed._toTerminals(e)}}function te(t,e,n){const s=I(e,n);class r extends ${constructor(){super(),this.name=t,this[_]=s}}const o=new r;return()=>o}const Ye=te("unknown",Me,()=>{}),j=te("string",Ce,t=>typeof t=="string"?void 0:Ie),qt=te("null",Fe,t=>t===null?void 0:Le),Jt=te("undefined",Ge,t=>t===void 0?void 0:je),ne=t=>new A(t,void 0),fe=t=>new A({},t??Ye()),U=t=>new K([],t??Ye(),[]),B=(...t)=>new Gt(t),Xt=/^#[^#]+$/,Wt=/^z[a-km-zA-HJ-NP-Z1-9]+$/,P=j().assert(t=>URL.canParse(t),"must be a url"),ye=j().assert(t=>Xt.test(t)||URL.canParse(t),"must be a did relative uri"),Zt=j().assert(t=>Wt.test(t),"must be a base58 multibase"),X=j().assert(De,"must be a did"),Re=ne({id:ye,type:j(),controller:X,publicKeyMultibase:Zt.optional(),publicKeyJwk:fe().optional()}).chain(t=>{switch(t.type){case"Multikey":{if(t.publicKeyMultibase===void 0)return G({message:"missing multikey",path:["publicKeyMultibase"]});break}case"EcdsaSecp256k1VerificationKey2019":case"EcdsaSecp256r1VerificationKey2019":{if(t.publicKeyMultibase===void 0)return G({message:"missing multibase key",path:["publicKeyMultibase"]});break}}return O(t)}),Vt=ne({id:ye,type:B(j(),U(j())),serviceEndpoint:B(P,fe(P),U(B(P,fe(P))))}),Yt=ne({"@context":U(P),id:X,alsoKnownAs:U(P).chain(t=>{for(let e=0,n=t.length;e<n;e++){const s=t[e];for(let r=0;r<e;r++)if(s===t[r])return G({message:`duplicate "${s}" aka entry`,path:[e]})}return O(t)}).optional(),verificationMethod:U(Re).chain(t=>{for(let e=0,n=t.length;e<n;e++){const r=t[e].id;for(let o=0;o<e;o++)if(r===t[o].id)return G({message:`duplicate "${r}" verification method`,path:[e,"id"]})}return O(t)}).optional(),service:U(Vt).optional(),controller:B(X,U(X)).optional(),authentication:U(B(ye,Re)).optional()}).chain(t=>{const{id:e,service:n}=t;if(n?.length){const s=n.length,r=new Array(s);for(let o=0;o<s;o++){let i=n[o].id;i[0]==="#"&&(i=e+i),r[o]=i}for(let o=0;o<s;o++){const a=r[o];for(let i=0;i<o;i++)if(a===r[i])return G({message:`duplicate "${a}" service`,path:["service",o,"id"]})}}return O(t)}),Qt="parse"in URL,en=t=>{let e=null;if(Qt)e=URL.parse(t);else try{e=new URL(t)}catch{}return e!==null&&(e.protocol==="https:"||e.protocol==="http:")&&e.pathname==="/"&&e.search===""&&e.hash===""},Te=t=>{const e=t.alsoKnownAs;if(!e)return null;const n="at://";for(let s=0,r=e.length;s<r;s++){const o=e[s];if(!o.startsWith(n))continue;const a=o.slice(n.length);return Rt(a)?a:void 0}return null},tn=(t,e)=>{const n=t.service;if(n)for(let s=0,r=n.length;s<r;s++){const{id:o,type:a,serviceEndpoint:i}=n[s];if(!(o!==e.id&&o!==t.id+e.id)){if(e.type!==void 0){if(Array.isArray(a)){if(!a.includes(e.type))continue}else if(a!==e.type)continue}if(!(typeof i!="string"||!en(i)))return i}}},nn=t=>tn(t,{id:"#atproto_pds",type:"AtprotoPersonalDataServer"}),sn=/^did:plc:([a-z2-7]{24})$/,rn=t=>t.length===32&&sn.test(t),on=/^did:web:([a-zA-Z0-9\-]+(?:\.[a-zA-Z0-9\-]+)*(?:\.[a-zA-Z]{2,})|localhost(?:%3[aA]\d+)?)$/,an=t=>t.length>=12&&on.test(t),cn=t=>{const[e,...n]=t.slice(8).split(":").map(decodeURIComponent);let s="/"+n.join("/");s==="/"?s="/.well-known/did.json":s+="/did.json";const r=new URL(`https://${e}${s}`);return r.hostname==="localhost"&&(r.protocol="http:"),r},un=t=>rn(t)||an(t),dn=t=>{const e=t.indexOf(":",4);return t.slice(4,e)},ln="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let me=(t=21)=>{let e="",n=crypto.getRandomValues(new Uint8Array(t|=0));for(;t--;)e+=ln[n[t]&63];return e};const fn=(t,e,n)=>s=>{const r=(1<<e)-1;let o="",a=0,i=0;for(let u=0;u<s.length;++u)for(i=i<<8|s[u],a+=8;a>e;)a-=e,o+=t[r&i>>a];if(a!==0&&(o+=t[r&i<<e-a]),n)for(;(o.length*e&7)!==0;)o+="=";return o},hn=(t,e,n)=>{const s={};for(let r=0;r<t.length;++r)s[t[r]]=r;return r=>{let o=r.length;for(;n&&r[o-1]==="=";)--o;const a=vt(o*e/8|0);let i=0,u=0,c=0;for(let f=0;f<o;++f){const l=s[r[f]];if(l===void 0)throw new SyntaxError("invalid base string");u=u<<e|l,i+=e,i>=8&&(i-=8,a[c++]=255&u>>i)}if(i>=e||(255&u<<8-i)!==0)throw new SyntaxError("unexpected end of data");return a}},pn=t=>Uint8Array.fromBase64(t,{alphabet:"base64url",lastChunkHandling:"loose"}),wn=t=>t.toBase64({alphabet:"base64url",omitPadding:!0}),Qe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",yn=hn(Qe,6,!1),mn=fn(Qe,6,!1),et="fromBase64"in Uint8Array,gn=et?pn:yn,q=et?wn:mn,V=typeof navigator<"u"?navigator.locks:void 0,ge=async t=>{const e=W(t),n=await Et(e);return q(n)},_n=async()=>{const t=me(64);return{verifier:t,challenge:await ge(t),method:"S256"}},vn=t=>{if(t!=null){const e=JSON.parse(t);if(e!=null)return e}return{}},En=({name:t})=>{const e=new AbortController,n=e.signal,s=(r,o,a=!1)=>{let i;const u=`${t}:${r}`,c=()=>i&&localStorage.setItem(u,JSON.stringify(i)),f=()=>{if(n.aborted)throw new Error("store closed");return i??=vn(localStorage.getItem(u))};{const l=d=>{d.key===u&&(i=void 0)};globalThis.addEventListener("storage",l,{signal:n})}{const l=async d=>{if(!d||n.aborted||(await new Promise(p=>setTimeout(p,1e4)),n.aborted))return;let w=Date.now(),h=!1;f();for(const p in i){const v=i[p].expiresAt;v!==null&&w>v&&(h=!0,delete i[p])}h&&c()};V?V.request(`${u}:cleanup`,{ifAvailable:!0},l):l(!0)}return{get(l){f();const d=i[l];if(!d)return;const w=d.expiresAt;if(w!==null&&Date.now()>w){delete i[l],c();return}return d.value},getWithLapsed(l){f();const d=i[l],w=Date.now();if(!d)return[void 0,1/0];const h=d.updatedAt;return h===void 0?[d.value,1/0]:[d.value,w-h]},set(l,d){f();const w={value:d,expiresAt:o(d),updatedAt:a?Date.now():void 0};i[l]=w,c()},delete(l){f(),i[l]!==void 0&&(delete i[l],c())},keys(){return f(),Object.keys(i)}}};return{dispose:()=>{e.abort()},sessions:s("sessions",({token:r})=>r.refresh?null:r.expires_at??null),states:s("states",r=>Date.now()+10*60*1e3),dpopNonces:s("dpopNonces",r=>Date.now()+24*60*60*1e3,!0),inflightDpop:new Map}};let _e,ve,he,S,tt;const Jn=t=>{({identityResolver:tt,fetchClientAssertion:he}=t),{client_id:_e,redirect_uri:ve}=t.metadata,S=En({name:t.storageName??"atcute-oauth"})};class F extends Error{name="LoginError"}class kn extends Error{name="AuthorizationError"}class R extends Error{name="ResolverError"}class Y extends Error{sub;name="TokenRefreshError";constructor(e,n,s){super(n,s),this.sub=e}}class nt extends Error{response;data;name="OAuthResponseError";error;description;constructor(e,n){const s=Ae(be(n)?.error),r=Ae(be(n)?.error_description),o=s?`"${s}"`:"unknown",a=r?`: ${r}`:"",i=`OAuth ${o} error${a}`;super(i),this.response=e,this.data=n,this.error=s,this.description=r}get status(){return this.response.status}get headers(){return this.response.headers}}let xn=class extends Error{response;status;name="FetchResponseError";constructor(e,n,s){super(s),this.response=e,this.status=n}};const Ae=t=>typeof t=="string"?t:void 0,be=t=>typeof t=="object"&&t!==null&&!Array.isArray(t)?t:void 0,se=t=>t.get("content-type")?.split(";")[0],st={name:"ECDSA",namedCurve:"P-256"},Rn=async()=>{const t=await crypto.subtle.generateKey(st,!0,["sign","verify"]),e=await crypto.subtle.exportKey("pkcs8",t.privateKey),{ext:n,key_ops:s,...r}=await crypto.subtle.exportKey("jwk",t.publicKey),o=JSON.stringify({crv:r.crv,kty:r.kty,x:r.x,y:r.y}),a=await ge(o);return{typ:"ES256",key:q(new Uint8Array(e)),jwt:q(W(JSON.stringify({typ:"dpop+jwt",alg:"ES256",jwk:r}))),jkt:a}},rt=t=>{const e=t.jwt,n=crypto.subtle.importKey("pkcs8",gn(t.key),st,!0,["sign"]),s=(r,o,a,i)=>{const u={ath:i,htm:r,htu:o,iat:Math.floor(Date.now()/1e3),jti:me(24),nonce:a};return q(W(JSON.stringify(u)))};return async(r,o,a,i)=>{const u=s(r,o,a,i),c=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},await n,W(e+"."+u)),f=q(new Uint8Array(c));return e+"."+u+"."+f}},Tn=(t,e)=>{const n=S.dpopNonces,s=S.inflightDpop,r=rt(t);return async(o,a)=>{const i=new Request(o,a),u=i.headers.get("authorization"),c=u?.startsWith("DPoP ")?await ge(u.slice(5)):void 0,{method:f,url:l}=i,{origin:d,pathname:w}=new URL(l),h=d+w;let p=s.get(d);p&&(await p.promise,p=void 0);let m,v=!1;try{const[g,E]=n.getWithLapsed(d);m=g,v=E>3*60*1e3}catch{}v&&s.set(d,p=Promise.withResolvers());let y;try{const g=await r(f,h,m,c);i.headers.set("dpop",g);const E=await fetch(i);if(y=E.headers.get("dpop-nonce"),y===null||y===m)return E;try{n.set(d,y)}catch{}if(!await An(E,e)||o===i||a?.body instanceof ReadableStream)return E}finally{p&&(s.delete(d),p.resolve())}{const g=await r(f,h,y,c),E=new Request(o,a);E.headers.set("dpop",g);const ae=await fetch(E),ce=ae.headers.get("dpop-nonce");if(ce!==null&&ce!==y)try{n.set(d,ce)}catch{}return ae}}},An=async(t,e)=>{if((e===void 0||e===!1)&&t.status===401){const n=t.headers.get("www-authenticate");if(n?.startsWith("DPoP"))return n.includes('error="use_dpop_nonce"')}if((e===void 0||e===!0)&&t.status===400&&se(t.headers)==="application/json")try{const n=await t.clone().json();return typeof n=="object"&&n?.error==="use_dpop_nonce"}catch{return!1}return!1},bn="parse"in URL,Sn=t=>{let e=null;if(bn)e=URL.parse(t);else try{e=new URL(t)}catch{}return e!==null?e.protocol==="https:"||e.protocol==="http:":!1},ot=async t=>{const e=await tt.resolve(t);return{identity:e,metadata:await at(e.pds)}},Dn=async t=>{try{return{metadata:await at(t)}}catch(e){if(e instanceof R)try{return{metadata:await it(t)}}catch{}throw e}},Un=async t=>{const e=new URL("/.well-known/oauth-protected-resource",t),n=await fetch(e.href,{redirect:"manual",headers:{accept:"application/json"}});if(n.status!==200||se(n.headers)!=="application/json")throw new R("unexpected response");const s=await n.json();if(s.resource!==e.origin)throw new R("unexpected issuer");return s},it=async t=>{const e=new URL("/.well-known/oauth-authorization-server",t),n=await fetch(e.href,{redirect:"manual",headers:{accept:"application/json"}});if(n.status!==200||se(n.headers)!=="application/json")throw new R("unexpected response");const s=await n.json();if(s.issuer!==e.origin)throw new R("unexpected issuer");if(!Sn(s.authorization_endpoint))throw new R("authorization server provided incorrect authorization endpoint");if(!s.client_id_metadata_document_supported)throw new R("authorization server does not support 'client_id_metadata_document'");if(!s.pushed_authorization_request_endpoint)throw new R("authorization server does not support 'pushed_authorization request'");if(s.response_types_supported&&!s.response_types_supported.includes("code"))throw new R("authorization server does not support 'code' response type");return s},at=async t=>{const e=await Un(t);if(e.authorization_servers?.length!==1)throw new R("expected exactly one authorization server in the listing");const n=e.authorization_servers[0],s=await it(n);if(s.protected_resources&&!s.protected_resources.includes(e.resource))throw new R("server is not in authorization server's jurisdiction");return s},In=(t,e)=>{const n={};for(let s=0,r=e.length;s<r;s++){const o=e[s];n[o]=t[o]}return n};class re{#e;#t;#n;constructor(e,n){this.#t=e,this.#n=n,this.#e=Tn(n,!0)}async request(e,n){const s=this.#t[`${e}_endpoint`];if(!s)throw new Error(`no endpoint for ${e}`);if((e==="token"||e==="pushed_authorization_request")&&he!==void 0){const a=this.#n.jkt;if(a===void 0)throw new Error("DPoP key missing jkt field");const i=await he({jkt:a,aud:this.#t.issuer,createDpopProof:async u=>await rt(this.#n)("POST",u,void 0,void 0)});n={...n,...i}}const r=await this.#e(s,{method:"post",headers:{"content-type":"application/json"},body:JSON.stringify({...n,client_id:_e})});if(se(r.headers)!=="application/json")throw new xn(r,2,"unexpected content-type");const o=await r.json();if(r.ok)return o;throw new nt(r,o)}async revoke(e){try{await this.request("revocation",{token:e})}catch{}}async exchangeCode(e,n){const s=await this.request("token",{grant_type:"authorization_code",redirect_uri:ve,code:e,code_verifier:n});try{return await this.#r(s)}catch(r){throw await this.revoke(s.access_token),r}}async refresh({sub:e,token:n}){if(!n.refresh)throw new Y(e,"no refresh token available");const s=await this.request("token",{grant_type:"refresh_token",refresh_token:n.refresh});try{if(e!==s.sub)throw new Y(e,`sub mismatch in token response; got ${s.sub}`);return this.#s(s)}catch(r){throw await this.revoke(s.access_token),r}}#s(e){if(!e.sub)throw new TypeError("missing sub field in token response");if(!e.scope)throw new TypeError("missing scope field in token response");if(e.token_type!=="DPoP")throw new TypeError("token response returned a non-dpop token");return{scope:e.scope,refresh:e.refresh_token,access:e.access_token,type:e.token_type,expires_at:typeof e.expires_in=="number"?Date.now()+e.expires_in*1e3:void 0}}async#r(e){const n=e.sub;if(!n)throw new TypeError("missing sub field in token response");const s=this.#s(e),r=await ot(n);if(r.metadata.issuer!==this.#t.issuer)throw new TypeError(`issuer mismatch; got ${r.metadata.issuer}`);return{token:s,info:{sub:n,aud:r.identity.pds,server:In(r.metadata,["issuer","authorization_endpoint","introspection_endpoint","pushed_authorization_request_endpoint","revocation_endpoint","token_endpoint"])}}}}const J=new Map,Wn=async(t,e)=>{e?.signal?.throwIfAborted();let n=Nn;e?.noCache?n=Ln:e?.allowStale&&(n=jn);let s;for(;s=J.get(t);){try{const{isFresh:i,value:u}=await s;if(i||n(u))return u}catch{}e?.signal?.throwIfAborted()}const r=async()=>{const i=S.sessions.get(t);if(i&&n(i))return{isFresh:!1,value:i};const u=await zn(t,i);return await ct(t,u),{isFresh:!0,value:u}};let o;if(V?o=V.request(`atcute-oauth:${t}`,r):o=r(),o=o.finally(()=>J.delete(t)),J.has(t))throw new Error("concurrent request for the same key");J.set(t,o);const{value:a}=await o;return a},ct=async(t,e)=>{try{S.sessions.set(t,e)}catch(n){throw await Pn(e),n}},Zn=t=>{S.sessions.delete(t)},jn=()=>!0,Ln=()=>!1,zn=async(t,e)=>{if(e===void 0)throw new Y(t,"session deleted by another tab");const{dpopKey:n,info:s,token:r}=e,o=new re(s.server,n);try{const a=await o.refresh({sub:s.sub,token:r});return{dpopKey:n,info:s,token:a}}catch(a){throw a instanceof nt&&a.status===400&&a.error==="invalid_grant"?new Y(t,"session was revoked",{cause:a}):a}},Pn=async({dpopKey:t,info:e,token:n})=>{await new re(e.server,t).revoke(n.refresh??n.access)},Nn=({token:t})=>{const e=t.expires_at;return e==null||Date.now()+6e4<=e},Vn=async t=>{const{target:e,scope:n,state:s=null,...r}=t;let o;switch(e.type){case"account":{o=await ot(e.identifier);break}case"pds":o=await Dn(e.serviceUrl)}const{identity:a,metadata:i}=o,u=a?a.handle!=="handle.invalid"?a.handle:a.did:void 0,c=me(24),f=await _n(),l=await Rn(),d={display:r.display,ui_locales:r.locale,prompt:r.prompt,redirect_uri:ve,code_challenge:f.challenge,code_challenge_method:f.method,state:c,login_hint:u,response_mode:"fragment",response_type:"code",scope:n};S.states.set(c,{dpopKey:l,metadata:i,verifier:f.verifier,state:s});const h=await new re(i,l).request("pushed_authorization_request",d),p=new URL(i.authorization_endpoint);return p.searchParams.set("client_id",_e),p.searchParams.set("request_uri",h.request_uri),p},Yn=async t=>{const e=t.get("iss"),n=t.get("state"),s=t.get("code"),r=t.get("error");if(!n||!(s||r))throw new F("missing parameters");const o=S.states.get(n);if(o)S.states.delete(n);else throw new F("unknown state provided");if(r)throw new kn(t.get("error_description")||r);if(!s)throw new F("missing code parameter");const a=o.dpopKey,i=o.metadata,u=o.state??null;if(e===null)throw new F("missing issuer parameter");if(e!==i.issuer)throw new F("issuer mismatch");const c=new re(i,a),{info:f,token:l}=await c.exchangeCode(s,o.verifier),d=f.sub,w={dpopKey:a,info:f,token:l};return await ct(d,w),{session:w,state:u}};class Ee extends Error{name="DidResolutionError"}class ke extends Ee{did;name="UnsupportedDidMethodError";constructor(e){super(`unsupported did method; did=${e}`),this.did=e}}class ut extends Ee{did;name="DocumentNotFoundError";constructor(e){super(`did document not found; did=${e}`),this.did=e}}class dt extends Ee{did;name="FailedDocumentResolutionError";constructor(e,n){super(`failed to resolve did document; did=${e}`,n),this.did=e}}class lt extends Error{name="HandleResolutionError"}class On extends lt{handle;name="DidNotFoundError";constructor(e){super(`handle returned no did; handle=${e}`),this.handle=e}}class $n extends lt{handle;name="FailedHandleResolutionError";constructor(e,n){super(`failed to resolve handle; handle=${e}`,n),this.handle=e}}class le extends Error{name="ActorResolutionError"}class Qn{handleResolver;didDocumentResolver;constructor(e){this.handleResolver=e.handleResolver,this.didDocumentResolver=e.didDocumentResolver}async resolve(e,n){const s=De(e);let r;if(s)r=e;else try{r=await this.handleResolver.resolve(e,n)}catch(u){throw new le("failed to resolve handle",{cause:u})}let o;try{o=await this.didDocumentResolver.resolve(r,n)}catch(u){throw new le("failed to resolve did document",{cause:u})}const a=nn(o);if(!a)throw new le("missing pds endpoint");let i="handle.invalid";if(s){const u=Te(o);if(u)try{await this.handleResolver.resolve(u,n)===r&&(i=u)}catch{}}else Te(o)===e&&(i=e);return{did:r,handle:i,pds:new URL(a).href}}}class es{#e;constructor({methods:e}){this.#e=new Map(Object.entries(e))}async resolve(e,n){const s=dn(e),r=this.#e.get(s);if(r===void 0)throw new ke(e);return await r.resolve(e,n)}}function ft(...t){return t.reduce(Mn)}const Mn=(t,e)=>n=>t(n).then(e);class oe extends Error{name="FetchResponseError"}class ie extends oe{response;name="FailedResponseError";constructor(e){super(`got http ${e.status}`),this.response=e}get status(){return this.response.status}}class Se extends oe{contentType;name="ImproperContentTypeError";constructor(e,n){super(n),this.contentType=e}}class pe extends oe{expectedSize;actualSize;name="ImproperContentLengthError";constructor(e,n,s){super(s),this.expectedSize=e,this.actualSize=n}}class Cn extends oe{name="ImproperResponseError";constructor(e,n){super(e,n)}}class Fn extends TransformStream{constructor(e){let n=0;super({transform(s,r){if(n+=s.length,n>e){r.error(new pe(e,n,"response content-length too large"));return}r.enqueue(s)}})}}const ht=async t=>{if(t.ok)return t;throw new ie(t)},pt=(t,e)=>async n=>{await Gn(n,t);const s=await Kn(n,e);try{const r=JSON.parse(s);return{response:n,json:r}}catch(r){throw new Cn("unexpected json data",{cause:r})}},wt=(t,e)=>async n=>{const s=t.parse(n.json,e);return{response:n.response,json:s}},Gn=async(t,e)=>{const n=t.headers.get("content-type")?.split(";",1)[0].trim();if(n===void 0)throw t.body&&await t.body.cancel(),new Se(null,"missing response content-type");if(!e.test(n))throw t.body&&await t.body.cancel(),new Se(n,"unexpected response content-type")},Kn=async(t,e)=>{const n=t.headers.get("content-length");if(n!==null){const o=Number(n);if(!Number.isSafeInteger(o)||o<=0)throw t.body?.cancel(),new pe(e,null,"invalid response content-length");if(o>e)throw t.body?.cancel(),new pe(e,o,"response content-length too large")}const s=t.body.pipeThrough(new Fn(e)).pipeThrough(new TextDecoderStream);let r="";for await(const o of Bn(s))r+=o;return r},Bn=Symbol.asyncIterator in ReadableStream.prototype?t=>t[Symbol.asyncIterator]():t=>{const e=t.getReader();return{[Symbol.asyncIterator](){return this},next(){return e.read()},async return(){return await e.cancel(),{done:!0,value:void 0}},async throw(n){return await e.cancel(n),{done:!0,value:void 0}}}},yt=ft(ht,pt(/^application\/(did\+ld\+)?json$/,20*1024),wt(Yt,{mode:"passthrough"}));class ts{apiUrl;#e;constructor({apiUrl:e="https://plc.directory",fetch:n=fetch}={}){this.apiUrl=e,this.#e=n}async resolve(e,n){if(!e.startsWith("did:plc:"))throw new ke(e);let s;try{const r=new URL(`/${encodeURIComponent(e)}`,this.apiUrl),o=await(0,this.#e)(r,{signal:n?.signal,cache:n?.noCache?"no-cache":void 0,redirect:"manual",headers:{accept:"application/did+ld+json,application/json"}});if(o.status>=300&&o.status<400)throw new TypeError("unexpected redirect");s=(await yt(o)).json}catch(r){throw r instanceof ie&&r.status===404?new ut(e):new dt(e,{cause:r})}return s}}class ns{#e;constructor({fetch:e=fetch}={}){this.#e=e}async resolve(e,n){if(!e.startsWith("did:web:"))throw new ke(e);let s;try{const r=cn(e),o=await(0,this.#e)(r,{signal:n?.signal,cache:n?.noCache?"no-cache":void 0,redirect:"manual",headers:{accept:"application/did+ld+json,application/json"}});if(o.status>=300&&o.status<400)throw new TypeError("unexpected redirect");s=(await yt(o)).json}catch(r){throw r instanceof ie&&r.status===404?new ut(e):new dt(e,{cause:r})}return s}}const Hn=ne({did:j().assert(t=>un(t))}),qn=ft(ht,pt(/^application\/json$/,4*1024),wt(Hn,{mode:"passthrough"}));class ss{serviceUrl;#e;constructor({serviceUrl:e,fetch:n=fetch}){this.serviceUrl=e,this.#e=n}async resolve(e,n){let s;try{const r=new URL("/xrpc/com.atproto.identity.resolveHandle",this.serviceUrl);r.searchParams.set("handle",e);const o=await(0,this.#e)(r,{signal:n?.signal,cache:n?.noCache?"no-cache":void 0,headers:{accept:"application/json"}});s=(await qn(o)).json}catch(r){throw r instanceof ie&&r.status===400?new On(e):new $n(e,{cause:r})}return s.did}}export{es as C,Qn as L,re as O,ts as P,ns as W,ss as X,Jn as a,Vn as b,Tn as c,Zn as d,Yn as f,Wn as g};
