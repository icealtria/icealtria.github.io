<!DOCTYPE html><html lang="zh-cn"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.16"><!-- Canonical URL --><link rel="canonical" href="https://icealtria.github.io/blog/passkey-101/"><!-- Primary Meta Tags --><title>如何实现一个简单的 Passkey 登录</title><meta name="title" content="如何实现一个简单的 Passkey 登录"><meta name="description" content="使用 Tailscale 实现"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://icealtria.github.io/blog/passkey-101/"><meta property="og:title" content="如何实现一个简单的 Passkey 登录"><meta property="og:description" content="使用 Tailscale 实现"><meta property="og:image" content="https://icealtria.github.io/assets/passkey.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://icealtria.github.io/blog/passkey-101/"><meta property="twitter:title" content="如何实现一个简单的 Passkey 登录"><meta property="twitter:description" content="使用 Tailscale 实现"><meta property="twitter:image" content="https://icealtria.github.io/assets/passkey.png"><link rel="stylesheet" href="/assets/about.css">
<link rel="stylesheet" href="/assets/about-1.css"></head> <body class="bg-background"> <header> <img class="mt-4 px-2 h-28 mx-auto dark:invert" draggable="false" src="/header.svg" alt="header"> <nav> <div class="flex justify-center my-4"> <a href="/" class="header-link flex items-center gap-1"> <svg width="1em" height="1em" data-icon="ic:baseline-home">   <symbol id="ai:ic:baseline-home" viewBox="0 0 24 24"><path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8z"/></symbol><use href="#ai:ic:baseline-home"></use>  </svg>首页 </a> <a href="/blog" class="header-link flex items-center gap-1"> <svg width="1em" height="1em" data-icon="ic:baseline-archive">   <symbol id="ai:ic:baseline-archive" viewBox="0 0 24 24"><path fill="currentColor" d="m20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27M12 17.5L6.5 12H10v-2h4v2h3.5zM5.12 5l.81-1h12l.94 1z"/></symbol><use href="#ai:ic:baseline-archive"></use>  </svg> 归档 </a> <a href="/friends" class="header-link flex items-center gap-1">  <svg width="1em" height="1em" data-icon="ic:baseline-contacts">   <symbol id="ai:ic:baseline-contacts" viewBox="0 0 24 24"><path fill="currentColor" d="M20 0H4v2h16zM4 24h16v-2H4zM20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m-8 2.75c1.24 0 2.25 1.01 2.25 2.25s-1.01 2.25-2.25 2.25S9.75 10.24 9.75 9S10.76 6.75 12 6.75M17 17H7v-1.5c0-1.67 3.33-2.5 5-2.5s5 .83 5 2.5z"/></symbol><use href="#ai:ic:baseline-contacts"></use>  </svg>友链
 </a> <a href="/about" class="header-link flex items-center gap-1"> <svg width="1em" height="1em" data-icon="ic:baseline-info">   <symbol id="ai:ic:baseline-info" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2m1 15h-2v-6h2zm0-8h-2V7h2z"/></symbol><use href="#ai:ic:baseline-info"></use>  </svg>关于 </a> </div> </nav> </header> <div class="mx-auto px-4">  <main class="max-w-4xl mx-auto rounded-2xl"> <img src="/assets/passkey_1NlNsi.avif" class="w-full rounded-2xl shadow-xl" alt="img of 如何实现一个简单的 Passkey 登录" loading="eager" width="1000" height="462" decoding="async"> <article> <div> <h1 class="mb-0">如何实现一个简单的 Passkey 登录</h1> <div class="text-sm font-light mt-4"> <span>icealtria</span><br> <time datetime="2024-12-09T00:00:00.000Z"> 2024. 12. 9. </time> </div> <div class="tags"><a class="tag" href="/tags/security">
#security</a><a class="tag" href="/tags/passkey">
#passkey</a></div> </div> <p>最近糊了个 meow-counter（<a href="#footer">Footer</a> 那个，魔改自 <a href="https://github.com/kotx/moco">moco</a>），但是统计面板不想公开，所以自然需要一个鉴权方式。我选择了 <strong>Passkey</strong>，也借此搞通了 Passkey 的验证流程。</p>
<hr>
<h2 id="为什么选择-passkey">为什么选择 Passkey?</h2>
<p>我不喜欢输密码，基于公钥认证的系统让我感觉更安心。就像使用 SSH，我也是仅支持公钥验证，完全不需要密码，安全性更高且劝退暴力破解者。</p>
<p>对于普通用户，Passkey 解决了密码泄露、钓鱼攻击等问题，简化了身份验证流程（无需额外的 2FA）。</p>
<hr>
<h2 id="不足之处">不足之处</h2>
<p>Passkey 通常绑定到设备或其生态系统（如 iCloud、Google 账号）。目前，除了使用 <strong>KeePassXC</strong> 外，几乎没有导出和导入的手段。 更换设备或丢失绑定设备时，可能会面临身份验证困难。 <a href="https://blog.1password.com/fido-alliance-import-export-passkeys-draft-specs/">未来或许会有更多密码管理器支持</a>。</p>
<blockquote>
<p><a href="https://fidoalliance.org/specs/cx/cxf-v1.0-wd-20240522.html">Credential Exchange Format</a>。</p>
</blockquote>
<hr>
<h2 id="注册与登录流程">注册与登录流程</h2>
<h3 id="注册流程">注册流程</h3>
<img alt="注册流程" decoding="async" loading="lazy" src="/d2/blog/passkey-101/index-0.svg" width="929" height="893">
<h3 id="登录流程">登录流程</h3>
<img alt="登录流程" decoding="async" loading="lazy" src="/d2/blog/passkey-101/index-1.svg" width="812" height="893">
<hr>
<h2 id="如何实现-passkey">如何实现 passkey</h2>
<h3 id="环境要求">环境要求</h3>
<ul>
<li>服务端需要支持 <strong>HTTPS</strong>，也可以是 <code>localhost</code>（WebAuthn 需要 <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts">Secure contexts</a>）。</li>
<li>后端推荐使用现成的库，比如 Node.js 的 <a href="https://github.com/MasterKale/SimpleWebAuthn">simplewebauthn</a>。不然验证挺繁琐的。</li>
</ul>
<p>下面都算伪代码，实际操作中 ArrayBuffer 编码为 Base64URL</p>
<hr>
<h3 id="用户注册">用户注册</h3>
<p>前端需要输入用户名，请求 <code>/api/registerStart</code>，获取 <code>publicKeyCredentialCreationOptions</code>。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> publicKeyCredentialCreationOptions</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    challenge: Uint8Array.</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">        randomStringFromServer, </span><span style="color:#FFAB70">c</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> c.</span><span style="color:#B392F0">charCodeAt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)), </span></span>
<span class="line"><span style="color:#E1E4E8">    rp: {</span></span>
<span class="line"><span style="color:#E1E4E8">        name: </span><span style="color:#9ECBFF">"Meow Counter"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        id: </span><span style="color:#9ECBFF">"example.com"</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// 浏览器会验证当前域名与 RP ID 是否匹配</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    user: {</span></span>
<span class="line"><span style="color:#E1E4E8">        id: Uint8Array.</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">            "UZSL85T9AFC"</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">c</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> c.</span><span style="color:#B392F0">charCodeAt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)),</span></span>
<span class="line"><span style="color:#E1E4E8">        name: </span><span style="color:#9ECBFF">"lee@example.com"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        displayName: </span><span style="color:#9ECBFF">"Lee"</span><span style="color:#E1E4E8">, </span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    pubKeyCredParams: [{ alg: </span><span style="color:#F97583">-</span><span style="color:#79B8FF">7</span><span style="color:#E1E4E8">, type: </span><span style="color:#9ECBFF">"public-key"</span><span style="color:#E1E4E8"> }], </span><span style="color:#6A737D">// 接受的算法</span></span>
<span class="line"><span style="color:#E1E4E8">    authenticatorSelection: {</span></span>
<span class="line"><span style="color:#E1E4E8">        authenticatorAttachment: </span><span style="color:#9ECBFF">"cross-platform"</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// 平台外部认证器</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    timeout: </span><span style="color:#79B8FF">60000</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    attestation: </span><span style="color:#9ECBFF">"direct"</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span></code></pre>
<p><strong>challenge</strong>:</p>
<p><code>challenge</code> 应该是一次性且短期有效的，使用后作废</p>
<ul>
<li>challenge 在 KV 中存储，应使用 Expired key。</li>
<li>每次请求新的 challenge，旧 challenge 立即作废。</li>
</ul>
<p><strong>rp</strong>:</p>
<p>假设你的 RP ID 设置为 example.com，只有在 example.com 或其子域 login.example.com 上调用 Passkey，验证会成功。</p>
<p><strong>authenticatorAttachment</strong>:</p>
<ul>
<li>platform：使用本地认证器（如 Windows Hello、Face ID）。</li>
<li>cross-platform：使用外部认证器（如 YubiKey，密码管理器）。</li>
</ul>
<h4 id="前端创建凭据">前端创建凭据</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> credential</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> navigator.credentials.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">    publicKey: publicKeyCredentialCreationOptions</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(credential);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">PublicKeyCredential {</span></span>
<span class="line"><span style="color:#B392F0">    id</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'ADSUllKQmbqdGtpu4sjseh4cg2TxSvrbcHDTBsv4NSSX9...'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    rawId</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">ArrayBuffer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">59</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">    response</span><span style="color:#E1E4E8">: AuthenticatorAttestationResponse {</span></span>
<span class="line"><span style="color:#B392F0">        clientDataJSON</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">ArrayBuffer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">121</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">        attestationObject</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">ArrayBuffer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">306</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#B392F0">    type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'public-key'</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">post</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'/api/registerFinish'</span><span style="color:#E1E4E8">, { credential });</span></span>
<span class="line"></span></code></pre>
<h4 id="服务端验证注册">服务端验证注册</h4>
<p>服务端需要保存 <code>challenge</code>，以供验证使用。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">verifyRegistrationResponse</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'@simplewebauthn/server'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> verification</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> verifyRegistrationResponse</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">    response: clientResponse,         </span><span style="color:#6A737D">// 前端返回的凭证数据</span></span>
<span class="line"><span style="color:#E1E4E8">    expectedChallenge: storedChallenge, </span></span>
<span class="line"><span style="color:#E1E4E8">    expectedOrigin: </span><span style="color:#9ECBFF">"https://example.com"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    expectedRPID: </span><span style="color:#9ECBFF">"example.com"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> (verification.verified) {</span></span>
<span class="line"><span style="color:#B392F0">    saveToDatabase</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">        credentialID: verification.registrationInfo.credentialID,</span></span>
<span class="line"><span style="color:#E1E4E8">        publicKey: verification.registrationInfo.credentialPublicKey,</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p><code>verifyRegistrationResponse</code> 会解析 <code>clientDataJSON</code>，将 <code>challenge</code> 与之前保存的进行比较以验证是否对应于当前注册事件。然后从 <code>attestationObject</code> 中获取 <code>credential.id</code> 和 <code>publicKey</code>，并将它们存储到数据库中。</p>
<hr>
<h3 id="用户登录">用户登录</h3>
<h4 id="服务端生成-challenge">服务端生成 challenge</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> publicKeyCredentialRequestOptions</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    challenge: Uint8Array.</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">        randomStringFromServer, </span><span style="color:#FFAB70">c</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> c.</span><span style="color:#B392F0">charCodeAt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)),</span></span>
<span class="line"><span style="color:#E1E4E8">    allowCredentials: [{</span></span>
<span class="line"><span style="color:#E1E4E8">        id: Uint8Array.</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">            credentialId, </span><span style="color:#FFAB70">c</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> c.</span><span style="color:#B392F0">charCodeAt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)),</span><span style="color:#6A737D">// optional，注册时保存的 credentialID</span></span>
<span class="line"><span style="color:#E1E4E8">        type: </span><span style="color:#9ECBFF">"public-key"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        transports: [</span><span style="color:#9ECBFF">"usb"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"ble"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"nfc"</span><span style="color:#E1E4E8">], </span><span style="color:#6A737D">// 支持的认证器传输方式</span></span>
<span class="line"><span style="color:#E1E4E8">    }],</span></span>
<span class="line"><span style="color:#E1E4E8">    timeout: </span><span style="color:#79B8FF">60000</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span></code></pre>
<h4 id="前端触发认证">前端触发认证</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> assertion</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> navigator.credentials.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">    publicKey: publicKeyCredentialRequestOptions</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(assertion);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">PublicKeyCredential {</span></span>
<span class="line"><span style="color:#B392F0">    id</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'ADSUllKQmbqdGtpu4sjseh4cg2TxSvrbcHDTBsv4NSSX9...'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#B392F0">    rawId</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">ArrayBuffer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">59</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">    response</span><span style="color:#E1E4E8">: AuthenticatorAssertionResponse {</span></span>
<span class="line"><span style="color:#B392F0">        authenticatorData</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">ArrayBuffer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">191</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">        clientDataJSON</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">ArrayBuffer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">118</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">        signature</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">ArrayBuffer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">70</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#B392F0">        userHandle</span><span style="color:#E1E4E8">: </span><span style="color:#B392F0">ArrayBuffer</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">), </span><span style="color:#6A737D">// optional, 注册时提供的用户ID。用于与服务器上的用户关联起来。服务端未提供 allowCredentialDescriptorList 的时候，服务端可以通过 userHandle 确定用户。</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#B392F0">    type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'public-key'</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">post</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'/api/loginFinish'</span><span style="color:#E1E4E8">, { assertion });</span></span>
<span class="line"></span></code></pre>
<h4 id="服务端验证登录">服务端验证登录</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">verifyAuthenticationResponse</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#B392F0"> require</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'@simplewebauthn/server'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> verification</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> verifyAuthenticationResponse</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">    response: clientResponse,        </span><span style="color:#6A737D">// 前端返回的数据</span></span>
<span class="line"><span style="color:#E1E4E8">    expectedChallenge: storedChallenge, </span></span>
<span class="line"><span style="color:#E1E4E8">    expectedOrigin: </span><span style="color:#9ECBFF">"https://example.com"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    expectedRPID: </span><span style="color:#9ECBFF">"example.com"</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    credential: storedCredential,    </span><span style="color:#6A737D">// 注册时保存的 credentialId 和 publicKey</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> (verification.verified) {</span></span>
<span class="line"><span style="color:#6A737D">    // 用户验证成功</span></span>
<span class="line"><span style="color:#B392F0">    grantAccessToUser</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>verifyAuthenticationResponse 验证 signature 和 clientDataJSON 是否与存储的 publicKey 匹配，确认登录成功。</p>
<p><span class="hidden-text">其实 Meow Counter 的 Passkey 没有完全实装，我在后端对比 public key 是否在数据库来验证的</span></p> </article> <div class="mx-4 my-12 md:mx-8 md:py-2"> <div class="comment mx-auto text-center"> <script src="https://giscus.app/client.js" data-repo="icealtria/astro-mylike-blog" data-repo-id="R_kgDOKISnYg" data-category="Announcements" data-category-id="DIC_kwDOKISnYs4CZLRJ" data-mapping="pathname" data-strict="0" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="en" crossorigin="anonymous" async></script> <noscript>Javascript is required</noscript> </div> </div> </main>  <footer class="flex my-8 flex-col items-center"> <img class="h-20" src="https://meow-counter.icealtria.workers.dev/get/passkey-101" alt="meow counter"> <div class="gap-2 flex justify-center items-center">
Copyright &copy; 2024 <span>icealtria</span>|
<a href="/atom.xml">RSS</a> </div> </footer> </div> </body></html>